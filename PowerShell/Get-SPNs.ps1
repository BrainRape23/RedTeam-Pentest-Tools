function Get-ADUserWithSPN {
    param (
        [string]$LDAPFilter = "(&(objectCategory=person)(objectClass=user)(!(sAMAccountName=krbtgt))(servicePrincipalName=*))",
        [string]$Domain = ""
    )
    # https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/decrypting-the-selection-of-supported-kerberos-encryption-types/ba-p/1628797
    
    $encryptionTypes = @{
        0  = "RC4"
        1  = "DES_CBC_CRC"
        2  = "DES_CBC_MD5"
        3  = "DES_CBC_CRC, DES_CBC_MD5"
        4  = "RC4"
        5  = "DES_CBC_CRC, RC4"
        6  = "DES_CBC_MD5, RC4"
        7  = "DES_CBC_CRC, DES_CBC_MD5, RC4"
        8  = "AES 128"
        9  = "DES_CBC_CRC, AES 128"
        10 = "DES_CBC_MD5, AES 128"
        11 = "DES_CBC_CRC, DES_CBC_MD5, AES 128"
        12 = "RC4, AES 128"
        13 = "DES_CBC_CRC, RC4, AES 128"
        14 = "DES_CBC_MD5, RC4, AES 128"
        15 = "DES_CBC_CRC, DES_CBC_MD5, RC4, AES 128"
        16 = "AES 256"
        17 = "DES_CBC_CRC, AES 256"
        18 = "DES_CBC_MD5, AES 256"
        19 = "DES_CBC_CRC, DES_CBC_MD5, AES 256"
        20 = "RC4, AES 256"
        21 = "DES_CBC_CRC, RC4, AES 256"
        22 = "DES_CBC_MD5, RC4, AES 256"
        23 = "DES_CBC_CRC, DES_CBC_MD5, RC4, AES 256"
        24 = "AES 128, AES 256"
        25 = "DES_CBC_CRC, AES 128, AES 256"
        26 = "DES_CBC_MD5, AES 128, AES 256"
        27 = "DES_CBC_CRC, DES_CBC_MD5, AES 128, AES 256"
        28 = "RC4, AES 128, AES 256"
        29 = "DES_CBC_CRC, RC4, AES 128, AES 256"
        30 = "DES_CBC_MD5, RC4, AES 128, AES 256"
        31 = "DES_CBC_CRC, DES_CBC_MD5, RC4, AES 128, AES 256"
    }

    $ADSearcher = New-Object System.DirectoryServices.DirectorySearcher([System.DirectoryServices.DirectoryEntry]::new($Domain), $LDAPFilter)
    $ADSearcher.PropertiesToLoad.AddRange(@("name", "servicePrincipalName", "msDS-SupportedEncryptionTypes"))

    $ADSearcher.FindAll() | ForEach-Object {
        $entry = $_.GetDirectoryEntry()
        foreach ($SPN in $entry.Properties["servicePrincipalName"]) {
            $etypeValue = $entry.Properties["msDS-SupportedEncryptionTypes"].Value
            
            if ($null -eq $etypeValue) {
                $etypeValue = 0
            }
            $etypeDescription = $encryptionTypes[$etypeValue]
            if (-not $etypeDescription) {
                $etypeDescription = "Unknown"
            }

            [PSCustomObject]@{
                UserName   = $entry.Properties["name"].Value + "   "
                SPN        = $SPN + "   "
                Encryption = $etypeDescription + " "
            }
        }
    } | Format-Table -AutoSize
}

Get-ADUserWithSPN
